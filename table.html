<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced Table Manager</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a33; --text:#e9eefc; --muted:#a8b3d6;
      --line:rgba(255,255,255,.10); --accent:#4f8cff; --danger:#ff6b6b; --success:#2ee59d;
      --chip:rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Arial;
      background: radial-gradient(1200px 600px at 20% 0%, #162a58 0%, var(--bg) 55%) fixed;
      color:var(--text);
    }
    .wrap{max-width:95%; margin:0 auto; padding:20px 0 60px;}
    
    /* Toolbar */
    .bar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 18px; border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:16px; margin-bottom: 16px;
      backdrop-filter: blur(10px);
      flex-wrap: wrap;
    }
    .left, .right { display:flex; align-items:center; gap:12px; }
    .title { font-weight:800; font-size: 1.2rem; letter-spacing:.5px; color: #fff; }
    
    /* Buttons */
    .btn {
      display:inline-flex; align-items:center; gap:8px;
      text-decoration:none; color:var(--text);
      padding:8px 14px; border-radius:8px;
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      font-weight:600; font-size:13px; cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover { background: rgba(255,255,255,.1); border-color: var(--accent); }
    .btn-primary { background: rgba(79,140,255,.15); border-color: rgba(79,140,255,.4); color: #8ab4ff; }
    .btn-primary:hover { background: rgba(79,140,255,.25); }
    .btn-danger { color: var(--danger); border-color: rgba(255,107,107,.3); background: rgba(255,107,107,.1); }

    /* Table Container */
    .panel{
      border:1px solid var(--line);
      background: rgba(15,26,51,.55);
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .table-wrap{overflow-x:auto; min-height: 300px;}
    table{border-collapse:collapse; width:100%; min-width:1000px;}
    
    /* Headers */
    thead th{
      position: sticky; top: 0; z-index: 5;
      background: #131d36;
      border-bottom:1px solid var(--line);
      padding:12px 10px;
      text-align:left; font-size:13px; color:var(--accent);
      white-space:nowrap;
      cursor: pointer; /* Clickable */
      user-select: none;
      transition: background 0.2s;
    }
    thead th:hover { background: #1c2a4d; }
    
    /* Sort Icons */
    .sort-icon { margin-left: 6px; font-size: 11px; opacity: 0.7; }
    
    /* Filter Inputs */
    .filter-row th {
      top: 45px;
      background: #0f182d;
      padding: 6px;
      cursor: default; /* Filter row is not sortable */
    }
    .filter-input {
      width: 100%;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--line);
      color: var(--text);
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 12px;
      outline: none;
    }
    .filter-input:focus { border-color: var(--accent); }

    /* Cells */
    tbody td{
      border-top:1px solid rgba(255,255,255,.04);
      padding:10px 10px;
      font-size:13px;
      white-space:nowrap;
      color: var(--muted);
      vertical-align: middle;
    }
    tbody tr:hover { background: rgba(255,255,255,.03); }
    
    .edit-input {
      background: rgba(0,0,0,0.4); border: 1px solid var(--accent);
      color: white; padding: 6px; border-radius: 4px; width: 100%;
    }

    .actions { display: flex; gap: 6px; }
    .icon-btn {
      padding: 6px; border-radius: 6px; border:none; cursor: pointer;
      font-size: 14px; transition: 0.2s;
    }
    .btn-edit { background: rgba(79,140,255,.15); color: var(--accent); }
    .btn-delete { background: rgba(255,107,107,.15); color: var(--danger); }
    .btn-save { background: rgba(46,229,157,.15); color: var(--success); }
    .btn-cancel { background: rgba(255,255,255,.1); color: var(--muted); }
    .icon-btn:hover { transform: scale(1.1); filter: brightness(1.2); }

    .status-badge {
      padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="left">
        <div class="title" id="tableTitle">LOADING...</div>
        <span style="color:var(--muted); font-size:13px;" id="recordCount">0 rows</span>
      </div>
      <div class="right">
        <button class="btn" onclick="addNewRow()"><i class="fa-solid fa-plus"></i> Add New</button>
        <button class="btn btn-primary" onclick="downloadCSV()"><i class="fa-solid fa-download"></i> Download CSV (Save)</button>
        <a class="btn" href="./"><i class="fa-solid fa-home"></i> Home</a>
      </div>
    </div>

    <div class="panel">
      <div class="table-wrap">
        <table id="mainTable">
          <thead>
            <tr id="headerRow"></tr>
            <tr id="filterRow" class="filter-row"></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
    
    <div style="margin-top:10px; font-size:12px; color:var(--muted); text-align:center;">
      <i class="fa-solid fa-info-circle"></i> Click headers to Sort. Use filters to Search. Edits happen in memory; click "Download CSV" to save.
    </div>
  </div>

  <script>
    // --- Configuration ---
    const FILE_MAP = {
      property: "data/property.csv",
      client:   "data/client.csv",
      agent:    "data/agent.csv",
      listing:  "data/listing.csv",
      viewing:  "data/viewing.csv",
      offer:    "data/offer.csv",
      sale:     "data/sale.csv"
    };

    const params = new URLSearchParams(location.search);
    const tableName = (params.get("t") || "property").toLowerCase();
    const csvPath = FILE_MAP[tableName] || FILE_MAP.property;

    document.getElementById("tableTitle").textContent = tableName.toUpperCase();
    document.title = `${tableName.toUpperCase()} - Manager`;

    // --- State ---
    let originalHeader = [];
    let tableData = []; 
    let filters = {};
    let editingRowId = null;
    let sortState = { colIdx: -1, asc: true }; // New Sorting State

    // --- Init ---
    fetch(csvPath)
      .then(r => {
        if(!r.ok) throw new Error("File not found");
        return r.text();
      })
      .then(csvText => parseAndInit(csvText))
      .catch(err => alert("Error: " + err.message));

    function parseAndInit(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length === 0) return;

      originalHeader = splitCSV(lines[0]);
      
      tableData = [];
      for(let i=1; i<lines.length; i++) {
        if(!lines[i].trim()) continue;
        const vals = splitCSV(lines[i]);
        const rowObj = { _id: Date.now() + Math.random() };
        originalHeader.forEach((h, idx) => {
          rowObj[idx] = vals[idx] || "";
        });
        tableData.push(rowObj);
      }
      renderHeader();
      renderFilters();
      renderBody();
    }

    // --- Render ---
    function renderHeader() {
      const tr = document.getElementById("headerRow");
      tr.innerHTML = "";
      
      // Data Columns (Sortable)
      originalHeader.forEach((h, idx) => {
        const th = document.createElement("th");
        th.onclick = () => handleSort(idx); // Sort Trigger
        
        // Header Text + Sort Icon
        let sortIcon = "";
        if (sortState.colIdx === idx) {
          sortIcon = sortState.asc 
            ? ' <i class="fa-solid fa-arrow-up-long sort-icon"></i>' 
            : ' <i class="fa-solid fa-arrow-down-long sort-icon"></i>';
        } else {
          sortIcon = ' <i class="fa-solid fa-sort sort-icon" style="opacity:0.2"></i>';
        }
        
        th.innerHTML = h + sortIcon;
        tr.appendChild(th);
      });

      // Actions Column (Not Sortable)
      const thAction = document.createElement("th");
      thAction.textContent = "Actions";
      thAction.style.width = "100px";
      thAction.style.textAlign = "right";
      thAction.style.cursor = "default";
      tr.appendChild(thAction);
    }

    function renderFilters() {
      const tr = document.getElementById("filterRow");
      tr.innerHTML = "";
      originalHeader.forEach((h, idx) => {
        const th = document.createElement("th");
        const input = document.createElement("input");
        input.className = "filter-input";
        input.placeholder = `Search ${h}...`;
        input.oninput = (e) => {
          filters[idx] = e.target.value.toLowerCase();
          renderBody();
        };
        // Stop sort click from propagating
        input.onclick = (e) => e.stopPropagation();
        th.appendChild(input);
        tr.appendChild(th);
      });
      tr.appendChild(document.createElement("th"));
    }

    function renderBody() {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      // 1. Filter
      const filtered = tableData.filter(row => {
        return Object.keys(filters).every(colIdx => {
          const val = (row[colIdx] || "").toString().toLowerCase();
          const term = filters[colIdx];
          return !term || val.includes(term);
        });
      });

      document.getElementById("recordCount").textContent = `${filtered.length} rows`;

      // 2. Render
      filtered.forEach(row => {
        const tr = document.createElement("tr");
        const isEditing = (row._id === editingRowId);

        originalHeader.forEach((colName, colIdx) => {
          const td = document.createElement("td");
          const val = row[colIdx];

          if (isEditing) {
            const input = document.createElement("input");
            input.className = "edit-input";
            input.value = val;
            input.dataset.colIdx = colIdx;
            td.appendChild(input);
          } else {
            if (looksLikeStatus(val)) {
              const span = document.createElement("span");
              span.className = "status-badge";
              span.style.cssText = getStatusStyle(val);
              span.textContent = val;
              td.appendChild(span);
            } else {
              td.textContent = val;
            }
          }
          tr.appendChild(td);
        });

        const tdAction = document.createElement("td");
        tdAction.className = "actions";
        tdAction.style.justifyContent = "flex-end";

        if (isEditing) {
          tdAction.append(
            createIconBtn("fa-check", "btn-save", () => saveRow(row._id, tr)),
            createIconBtn("fa-xmark", "btn-cancel", () => cancelEdit())
          );
        } else {
          tdAction.append(
            createIconBtn("fa-pen", "btn-edit", () => startEdit(row._id)),
            createIconBtn("fa-trash", "btn-delete", () => deleteRow(row._id))
          );
        }

        tr.appendChild(tdAction);
        tbody.appendChild(tr);
      });
    }

    // --- Sort Logic ---
    function handleSort(idx) {
      if (sortState.colIdx === idx) {
        sortState.asc = !sortState.asc; // Toggle
      } else {
        sortState.colIdx = idx;
        sortState.asc = true; // Default new col to asc
      }

      // Sort the actual data array
      tableData.sort((a, b) => {
        const valA = (a[idx] || "").toString();
        const valB = (b[idx] || "").toString();

        // Check if numeric
        const nA = Number(valA.replace(/[^0-9.-]/g,""));
        const nB = Number(valB.replace(/[^0-9.-]/g,""));
        const isNum = !isNaN(nA) && !isNaN(nB) && valA.trim() !== "" && valB.trim() !== "";

        if(isNum) {
           return sortState.asc ? (nA - nB) : (nB - nA);
        } else {
           // String compare (case insensitive + numeric aware for "Item 1, Item 10")
           return sortState.asc 
             ? valA.localeCompare(valB, undefined, {numeric: true, sensitivity: 'base'})
             : valB.localeCompare(valA, undefined, {numeric: true, sensitivity: 'base'});
        }
      });

      renderHeader(); // Update arrows
      renderBody();   // Update rows
    }

    // --- CRUD ---
    function addNewRow() {
      const newRow = { _id: Date.now() };
      originalHeader.forEach((h, i) => newRow[i] = "");
      tableData.unshift(newRow);
      editingRowId = newRow._id;
      filters = {}; // reset filters to see new row
      document.querySelectorAll(".filter-input").forEach(i => i.value = "");
      renderBody();
    }

    function startEdit(id) { editingRowId = id; renderBody(); }
    function cancelEdit() { editingRowId = null; renderBody(); }
    function deleteRow(id) {
      if(!confirm("Delete this row?")) return;
      tableData = tableData.filter(r => r._id !== id);
      renderBody();
    }
    function saveRow(id, tr) {
      const inputs = tr.querySelectorAll("input.edit-input");
      const targetRow = tableData.find(r => r._id === id);
      inputs.forEach(input => targetRow[input.dataset.colIdx] = input.value);
      editingRowId = null;
      renderBody();
    }

    // --- Utils ---
    function createIconBtn(icon, cls, cb) {
      const btn = document.createElement("button");
      btn.className = `icon-btn ${cls}`;
      btn.innerHTML = `<i class="fa-solid ${icon}"></i>`;
      btn.onclick = cb;
      return btn;
    }
    function getStatusStyle(status) {
      const s = status.toLowerCase();
      if(s === 'active' || s === 'available') return "background: rgba(46,229,157,.15); color: #2ee59d; border: 1px solid rgba(46,229,157,.3);";
      if(s === 'sold' || s === 'rejected') return "background: rgba(255,107,107,.15); color: #ff6b6b; border: 1px solid rgba(255,107,107,.3);";
      if(s.includes('under') || s === 'pending') return "background: rgba(255,200,87,.15); color: #ffc857; border: 1px solid rgba(255,200,87,.3);";
      return "background: rgba(255,255,255,.1); color: #ccc;";
    }
    function looksLikeStatus(val) {
      const s = (val||"").toString().toLowerCase();
      return ['active','sold','pending','available','rejected','accepted'].some(x => s.includes(x));
    }
    function splitCSV(str) {
      const arr = [];
      let quote = false, col = "";
      for(let c of str) {
        if(c === '"') { quote = !quote; continue; }
        if(c === ',' && !quote) { arr.push(col); col = ""; continue; }
        col += c;
      }
      arr.push(col);
      return arr.map(x => x.trim());
    }
    function downloadCSV() {
      let csvContent = originalHeader.join(",") + "\n";
      tableData.forEach(row => {
        const rowArr = originalHeader.map((_, idx) => {
          let val = row[idx] || "";
          if (val.includes(",")) val = `"${val}"`;
          return val;
        });
        csvContent += rowArr.join(",") + "\n";
      });
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `${tableName}_updated.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
